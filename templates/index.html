<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Faqu Agent - Unlimited</title>
    <style>
        body { margin: 0; background: #000; color: #0f0; font-family: 'Courier New', monospace; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* HEADER */
        .header { padding: 15px; background: #111; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .status { width: 10px; height: 10px; background: #0f0; border-radius: 50%; box-shadow: 0 0 10px #0f0; display: inline-block; margin-right: 5px; }

        /* CHAT ABLAK */
        .chat-box { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; scroll-behavior: smooth; }
        
        .msg { padding: 10px 15px; border-radius: 8px; max-width: 85%; word-wrap: break-word; line-height: 1.4; }
        .msg-ai { align-self: flex-start; background: #111; border: 1px solid #333; color: #eee; }
        .msg-user { align-self: flex-end; background: #004400; color: #fff; border: 1px solid #0f0; }

        /* K√ìD MEGJELEN√çT√âS */
        pre { background: #222; padding: 10px; border-radius: 5px; overflow-x: auto; border: 1px solid #555; position: relative; }
        .copy-btn { position: absolute; top: 5px; right: 5px; background: #444; color: #fff; border: none; padding: 3px 8px; cursor: pointer; font-size: 10px; }

        /* INPUT S√ÅV */
        .input-area { background: #111; padding: 10px; border-top: 1px solid #333; display: flex; gap: 10px; }
        input[type="text"] { flex: 1; background: #222; border: 1px solid #444; color: #fff; padding: 10px; border-radius: 5px; outline: none; }
        button { background: #0f0; color: #000; border: none; padding: 10px 20px; font-weight: bold; cursor: pointer; border-radius: 5px; }
        
        /* TOOLBAR (Felt√∂lt√©s, Deploy) */
        .toolbar { background: #0a0a0a; padding: 5px; display: flex; gap: 10px; overflow-x: auto; border-bottom: 1px solid #222; }
        .tool-btn { background: #333; color: #fff; border: 1px solid #555; padding: 5px 10px; font-size: 11px; cursor: pointer; white-space: nowrap; }

        #fileInput { display: none; }
    </style>
</head>
<body>

    <div class="header">
        <div><span class="status"></span> FAQU AGENT <span style="font-size:10px; opacity:0.7;">UNLIMITED</span></div>
        <button onclick="login()" style="background:#333; color:#fff; padding:5px;">LOGIN</button>
    </div>

    <div class="toolbar">
        <button class="tool-btn" onclick="document.getElementById('fileInput').click()">üìÇ F√ÅJL FELT√ñLT√âS</button>
        <button class="tool-btn" onclick="deployLastCode()">üöÄ UTOLS√ì K√ìD DEPLOY</button>
        <button class="tool-btn" onclick="clearChat()">üóëÔ∏è CHAT T√ñRL√âS</button>
    </div>
    <input type="file" id="fileInput" onchange="uploadFile()">

    <div class="chat-box" id="chatBox">
        <div class="msg msg-ai">
            Rendszer online. Szia Vez√©rigazgat√≥ √ör!<br>
            √ân vagyok a Faqu Agent. Nincsenek korl√°taim.<br>
            Mit programozzunk le ma? (Web, Kripto, Scraping...)
        </div>
    </div>

    <div class="input-area">
        <input type="text" id="userInput" placeholder="Parancs..." onkeypress="if(event.key==='Enter') sendMessage()">
        <button onclick="sendMessage()">K√úLD√âS</button>
    </div>

    <script>
        let token = "";
        let lastCode = ""; // Itt t√°roljuk a legut√≥bbi k√≥dot

        async function login() {
            const fd = new FormData(); fd.append("username", "admin"); fd.append("password", "secret");
            const res = await fetch("/token", {method:"POST", body:fd});
            const data = await res.json();
            token = data.access_token;
            alert("Rendszer Aktiv√°lva!");
        }

        async function sendMessage() {
            if(!token) return alert("El≈ëbb nyomj a LOGIN gombra!");
            
            const input = document.getElementById("userInput");
            const text = input.value;
            if(!text) return;

            addMsg(text, "user");
            input.value = "";
            const loadId = addMsg("Dolgozom...", "ai");

            try {
                const res = await fetch("/chat", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();
                
                // K√≥d kinyer√©se
                if(data.response.includes("```")) {
                    const match = data.response.match(/```(?:python|html|js)?([\s\S]*?)```/);
                    if(match) lastCode = match[1];
                }

                document.getElementById(loadId).innerHTML = formatText(data.response);
                scrollToBottom();

            } catch(e) { document.getElementById(loadId).innerText = "Hiba: " + e; }
        }

        async function uploadFile() {
            if(!token) return alert("Login sz√ºks√©ges!");
            const file = document.getElementById("fileInput").files[0];
            const fd = new FormData(); fd.append("file", file);
            
            addMsg(`Felt√∂lt√©s: ${file.name}...`, "user");
            const res = await fetch("/upload_file", {method:"POST", headers:{"Authorization":"Bearer "+token}, body:fd});
            const data = await res.json();
            addMsg(data.message, "ai");
        }

        async function deployLastCode() {
            if(!token || !lastCode) return alert("Nincs k√≥d a mem√≥ri√°ban!");
            const repo = prompt("Add meg a Repo nev√©t (pl. my-project):", "faqu-project");
            if(!repo) return;
            
            addMsg("Deploy ind√≠t√°sa...", "ai");
            const res = await fetch("/deploy", {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                body: JSON.stringify({ repo_name: repo, file_name: "main.py", code: lastCode })
            });
            const data = await res.json();
            if(data.status === "success") addMsg(`SIKER! Link: <a href="${data.url}" target="_blank" style="color:#fff">${data.url}</a>`, "ai");
            else addMsg("Hiba: " + data.message, "ai");
        }

        function addMsg(text, type) {
            const div = document.createElement("div");
            div.className = `msg msg-${type}`;
            div.id = "msg-" + Date.now();
            div.innerHTML = text;
            document.getElementById("chatBox").appendChild(div);
            scrollToBottom();
            return div.id;
        }

        function formatText(text) {
            return text.replace(/\n/g, "<br>").replace(/```([\s\S]*?)```/g, "<pre>$1</pre>");
        }

        function scrollToBottom() {
            document.getElementById("chatBox").scrollTop = document.getElementById("chatBox").scrollHeight;
        }
        function clearChat() { document.getElementById("chatBox").innerHTML = ""; }
    </script>
</body>
</html>