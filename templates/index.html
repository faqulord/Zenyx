<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Agent AI - Private Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0f1117; --sidebar: #161b22; --input: #21262d; --accent: #238636; --text: #c9d1d9; --user-msg: #1f6feb; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }
        
        /* SIDEBAR (Eszk√∂z√∂k) */
        .sidebar { width: 300px; background: var(--sidebar); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #30363d; }
        .sidebar h2 { color: #fff; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; }
        .tool-box { background: var(--input); padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #30363d; }
        .tool-box h3 { margin: 0 0 10px 0; font-size: 14px; color: #8b949e; text-transform: uppercase; }
        .sidebar input { width: 100%; padding: 10px; background: #0d1117; border: 1px solid #30363d; color: white; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; }
        .btn-tool { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        .btn-learn { background: #d29922; color: #000; }
        .btn-deploy { background: #8957e5; color: #fff; }
        .btn-tool:hover { opacity: 0.9; }

        /* CHAT AREA */
        .chat-container { flex: 1; display: flex; flex-direction: column; position: relative; }
        .chat-window { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }
        
        .message { max-width: 80%; padding: 15px 20px; border-radius: 12px; line-height: 1.5; font-size: 15px; }
        .msg-ai { align-self: flex-start; background: #161b22; border: 1px solid #30363d; color: #e6edf3; }
        .msg-user { align-self: flex-end; background: var(--user-msg); color: white; }
        
        .code-block { background: #000; padding: 15px; border-radius: 6px; font-family: monospace; overflow-x: auto; margin-top: 10px; border: 1px solid #30363d; color: #0f0; }

        /* INPUT AREA */
        .input-area { padding: 20px; background: var(--sidebar); border-top: 1px solid #30363d; display: flex; gap: 10px; }
        textarea { flex: 1; background: var(--input); border: 1px solid #30363d; color: white; padding: 15px; border-radius: 8px; resize: none; font-family: inherit; outline: none; height: 50px; }
        .btn-send { background: var(--accent); color: white; border: none; padding: 0 25px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; }
        .btn-send:hover { background: #2ea043; }

        /* Token Input (Hidden logic) */
        #tokenInput { display: none; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üöÄ PROFIT AGENT</h2>
        
        <div class="tool-box" id="loginBox">
            <h3>üîë Rendszer Bel√©p√©s</h3>
            <button class="btn-tool" style="background:#238636; color:#fff;" onclick="login()">Rendszer Ind√≠t√°sa</button>
        </div>

        <div class="tool-box">
            <h3>üß† Tud√°sb√°zis (Web)</h3>
            <input type="text" id="learnUrl" placeholder="URL (pl. t≈ëzsde h√≠rek)...">
            <button class="btn-tool btn-learn" onclick="learn()">Tanuld meg!</button>
        </div>

        <div class="tool-box">
            <h3>üì¶ GitHub Deploy</h3>
            <input type="text" id="repoName" placeholder="Projekt neve...">
            <input type="text" id="fileName" placeholder="F√°jl (pl. main.py)...">
            <button class="btn-tool btn-deploy" onclick="deploy()">K√≥d Felt√∂lt√©se</button>
        </div>
        
        <div style="margin-top:auto; font-size:12px; color:#666;">
            Target: 3000‚Ç¨/h√≥<br>
            Status: <span style="color:#0f0">ONLINE</span>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-window" id="chatWindow">
            <div class="message msg-ai">
                üëã Szia! √ân vagyok a priv√°t fejleszt≈ë t√°rsad. <br>
                Mire f√≥kusz√°ljunk ma? Banki rendszer, Weboldal, vagy keressek "kiskapukat" a neten?
            </div>
        </div>
        
        <div class="input-area">
            <textarea id="userInput" placeholder="√çrd le a feladatot vagy k√©rdezz b√°rmit..."></textarea>
            <button class="btn-send" onclick="sendMessage()">K√úLD√âS</button>
        </div>
    </div>

    <script>
        let token = "";
        let lastGeneratedCode = ""; // Itt t√°roljuk a legut√≥bbi k√≥dot a deployhoz

        async function login() {
            const formData = new FormData();
            formData.append("username", "faqu");
            formData.append("password", "admin123");
            
            try {
                const res = await fetch("/token", { method: "POST", body: formData });
                const data = await res.json();
                token = data.access_token;
                document.getElementById("loginBox").innerHTML = "<h3 style='color:#0f0'>‚úÖ Csatlakozva</h3>";
                addMessage("Rendszer sikeresen hiteles√≠tve. Hozz√°f√©r√©sem van az adatb√°zisokhoz.", "ai");
            } catch(e) { alert("Hiba a bel√©p√©sn√©l!"); }
        }

        async function sendMessage() {
            if(!token) { alert("El≈ëbb ind√≠tsd el a rendszert (Bal oldalt)!"); return; }
            
            const input = document.getElementById("userInput");
            const text = input.value;
            if(!text) return;

            addMessage(text, "user");
            input.value = "";

            // Bet√∂lt√©s jelz≈ë
            const loadingId = addMessage("Gondolkodom...", "ai");

            try {
                const res = await fetch("/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ prompt: text, project_name: "chat_session" })
                });
                const data = await res.json();
                
                // Friss√≠tj√ºk az √ºzenetet a v√°lasszal
                document.getElementById(loadingId).innerHTML = formatResponse(data.response);
                
                // Ha van k√≥d a v√°laszban, elmentj√ºk, hogy fel lehessen t√∂lteni
                if(data.response.includes("```")) {
                    lastGeneratedCode = extractCode(data.response);
                }

            } catch(e) {
                document.getElementById(loadingId).innerText = "Hiba t√∂rt√©nt: " + e;
            }
        }

        async function learn() {
            if(!token) return alert("Jelentkezz be!");
            const url = document.getElementById("learnUrl").value;
            addMessage("Kezdem a tanul√°st: " + url, "ai");
            
            try {
                const res = await fetch("/learn", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ url: url })
                });
                const data = await res.json();
                addMessage("‚úÖ MEGTANULTAM! √ñsszefoglal√≥: " + data.summary, "ai");
            } catch(e) { addMessage("Hiba a tanul√°sban.", "ai"); }
        }

        async function deploy() {
            if(!token) return alert("Jelentkezz be!");
            if(!lastGeneratedCode) return alert("M√©g nem gener√°ltam k√≥dot amit felt√∂lthetn√©k!");
            
            const repo = document.getElementById("repoName").value || "profit-agent-auto";
            const file = document.getElementById("fileName").value || "main.py";

            addMessage(`Felt√∂lt√©s a GitHubra (${repo}/${file})...`, "ai");

            try {
                const res = await fetch("/deploy-github", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ project_name: repo, file_name: file, code_content: lastGeneratedCode })
                });
                const data = await res.json();
                addMessage(`üöÄ SIKERES FELT√ñLT√âS! El√©rhet≈ë itt: <a href="${data.url}" target="_blank" style="color:#fff">Megnyit√°s</a>`, "ai");
            } catch(e) { addMessage("Hiba a felt√∂lt√©sn√©l: " + e, "ai"); }
        }

        // Seg√©df√ºggv√©nyek
        function addMessage(text, sender) {
            const div = document.createElement("div");
            div.className = `message msg-${sender}`;
            div.id = "msg-" + Date.now();
            div.innerHTML = sender === 'ai' ? formatResponse(text) : text;
            document.getElementById("chatWindow").appendChild(div);
            document.getElementById("chatWindow").scrollTop = document.getElementById("chatWindow").scrollHeight;
            return div.id;
        }

        function formatResponse(text) {
            // Sort√∂r√©sek √©s K√≥dblokkok form√°z√°sa
            let formatted = text.replace(/\n/g, "<br>");
            formatted = formatted.replace(/```([\s\S]*?)```/g, "<div class='code-block'>$1</div>");
            return formatted;
        }

        function extractCode(text) {
            const match = text.match(/```([\s\S]*?)```/);
            return match ? match[1] : text;
        }
    </script>
</body>
</html>