<!DOCTYPE html>
<html lang="hu">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Profit Agent AI - OmniBrain Edition</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        :root { --bg: #0d1117; --sidebar: #161b22; --input: #21262d; --accent: #238636; --text: #c9d1d9; --user-msg: #1f6feb; --ai-msg: #161b22; }
        body { margin: 0; font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); display: flex; height: 100vh; overflow: hidden; }

        /* SIDEBAR (Eszk√∂z√∂k) */
        .sidebar { width: 320px; background: var(--sidebar); padding: 20px; display: flex; flex-direction: column; border-right: 1px solid #30363d; overflow-y: auto; }
        .sidebar h2 { color: #fff; font-size: 18px; margin-bottom: 20px; display: flex; align-items: center; border-bottom: 1px solid #30363d; padding-bottom: 10px; }
        
        .tool-box { background: #0d1117; padding: 15px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #30363d; }
        .tool-box h3 { margin: 0 0 10px 0; font-size: 13px; color: #8b949e; text-transform: uppercase; letter-spacing: 1px; }
        
        .sidebar input[type="text"], .sidebar input[type="password"] { width: 100%; padding: 10px; background: #21262d; border: 1px solid #30363d; color: white; border-radius: 4px; box-sizing: border-box; margin-bottom: 10px; font-size: 13px; }
        .sidebar input[type="file"] { margin-bottom: 10px; font-size: 12px; color: #8b949e; }
        
        .btn-tool { width: 100%; padding: 10px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; transition: 0.2s; font-size: 13px; text-transform: uppercase; }
        .btn-login { background: #238636; color: #fff; }
        .btn-upload { background: #1f6feb; color: #fff; }
        .btn-learn { background: #d29922; color: #000; }
        .btn-deploy { background: #8957e5; color: #fff; }
        .btn-tool:hover { opacity: 0.9; transform: translateY(-1px); }

        /* CHAT AREA */
        .chat-container { flex: 1; display: flex; flex-direction: column; position: relative; background: #010409; }
        .chat-window { flex: 1; padding: 40px; overflow-y: auto; display: flex; flex-direction: column; gap: 20px; scroll-behavior: smooth; }

        .message { max-width: 85%; padding: 15px 20px; border-radius: 8px; line-height: 1.6; font-size: 15px; box-shadow: 0 1px 3px rgba(0,0,0,0.5); }
        .msg-ai { align-self: flex-start; background: var(--ai-msg); border: 1px solid #30363d; color: #e6edf3; }
        .msg-user { align-self: flex-end; background: var(--user-msg); color: white; }

        /* K√≥d blokk st√≠lus */
        .code-block { background: #0d1117; padding: 15px; border-radius: 6px; font-family: 'Courier New', monospace; overflow-x: auto; margin-top: 10px; border: 1px solid #30363d; color: #7ee787; font-size: 14px; }
        strong { color: #fff; }

        /* INPUT AREA */
        .input-area { padding: 20px; background: var(--sidebar); border-top: 1px solid #30363d; display: flex; gap: 10px; align-items: center; }
        textarea { flex: 1; background: #0d1117; border: 1px solid #30363d; color: white; padding: 15px; border-radius: 8px; resize: none; font-family: inherit; outline: none; height: 50px; transition: 0.2s; }
        textarea:focus { border-color: #1f6feb; }
        .btn-send { background: var(--accent); color: white; border: none; padding: 0 30px; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 16px; height: 50px; }
        .btn-send:hover { background: #2ea043; }

        /* Status bar */
        .status-bar { padding: 10px; font-size: 12px; color: #8b949e; border-top: 1px solid #30363d; display: flex; justify-content: space-between; }
    </style>
</head>
<body>

    <div class="sidebar">
        <h2>üöÄ PROFIT AGENT <span style="font-size:10px; background:#238636; padding:2px 6px; border-radius:10px; margin-left:10px;">PRO</span></h2>

        <div class="tool-box" id="loginBox">
            <h3>üîë Rendszer Bel√©p√©s</h3>
            <button class="btn-tool btn-login" onclick="login()">Rendszer Ind√≠t√°sa</button>
        </div>

        <div class="tool-box">
            <h3>üìÇ Tud√°s Felt√∂lt√©s (F√°jl)</h3>
            <div style="font-size:11px; color:#8b949e; margin-bottom:5px;">PDF, TXT, PY, MD</div>
            <input type="file" id="fileInput">
            <input type="text" id="fileNotes" placeholder="Megjegyz√©s (pl. MLM k√∂nyv)...">
            <button class="btn-tool btn-upload" onclick="uploadFile()">Tanuld meg a F√°jlt!</button>
        </div>

        <div class="tool-box">
            <h3>üåê Tud√°sb√°zis (Web)</h3>
            <input type="text" id="learnUrl" placeholder="URL (pl. t≈ëzsde h√≠rek)...">
            <button class="btn-tool btn-learn" onclick="learnUrl()">Weboldal Elemz√©se</button>
        </div>

        <div class="tool-box">
            <h3>üì¶ GitHub Deploy</h3>
            <input type="text" id="repoName" placeholder="Repo neve (pl. sniper-bot)...">
            <input type="text" id="fileName" placeholder="F√°jl (pl. main.py)...">
            <button class="btn-tool btn-deploy" onclick="deploy()">K√≥d √âles√≠t√©se</button>
        </div>

        <div style="margin-top:auto; font-size:11px; color:#484f58; text-align:center;">
            System: <strong>ONLINE</strong> | Mode: <strong>HACKER/BANKER</strong>
        </div>
    </div>

    <div class="chat-container">
        <div class="chat-window" id="chatWindow">
            <div class="message msg-ai">
                üëã <strong>√údv√∂z√∂llek, Vez√©rigazgat√≥ √ör!</strong><br><br>
                A rendszerem friss√ºlt. Most m√°r k√©pes vagyok:<br>
                1. üìÑ <strong>PDF k√∂nyveket olvasni</strong> (t√∂ltsd fel bal oldalt!)<br>
                2. üè¶ <strong>Banki szint≈± adatb√°zisokat</strong> kezelni.<br>
                3. üïµÔ∏è‚Äç‚ôÇÔ∏è <strong>Mindent megtanulni</strong>, amit bet√°pl√°lsz.<br><br>
                <em>Melyik f√°jllal kezdj√ºk a tan√≠t√°st?</em>
            </div>
        </div>

        <div class="input-area">
            <textarea id="userInput" placeholder="√çrd le a parancsot... (pl. √çrj egy MLM k√≥dot a felt√∂lt√∂tt k√∂nyv alapj√°n)"></textarea>
            <button class="btn-send" onclick="sendMessage()">K√úLD√âS</button>
        </div>
    </div>

    <script>
        let token = "";
        let lastGeneratedCode = ""; 

        // 1. BEL√âP√âS
        async function login() {
            const formData = new FormData();
            formData.append("username", "admin"); // Egyszer≈±s√≠tett admin
            formData.append("password", "secret");

            try {
                const res = await fetch("/token", { method: "POST", body: formData });
                const data = await res.json();
                token = data.access_token;
                document.getElementById("loginBox").innerHTML = "<h3 style='color:#3fb950; text-align:center;'>‚úÖ Rendszer Akt√≠v</h3>";
                addMessage("Azonos√≠t√°s sikeres. A mem√≥ri√°m k√©szen √°ll a f√°jlok fogad√°s√°ra.", "ai");
            } catch(e) { alert("Hiba a bel√©p√©sn√©l!"); }
        }

        // 2. √úZENET K√úLD√âS (Gener√°l√°s)
        async function sendMessage() {
            if(!token) { alert("K√©rlek ind√≠tsd el a rendszert (Bal fel√ºl)!"); return; }

            const input = document.getElementById("userInput");
            const text = input.value;
            if(!text) return;

            addMessage(text, "user");
            input.value = "";

            const loadingId = addMessage("Elemz√©s a tud√°sb√°zis alapj√°n...", "ai");

            try {
                const res = await fetch("/generate", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ prompt: text, project_name: "current_session" })
                });
                const data = await res.json();

                document.getElementById(loadingId).innerHTML = formatResponse(data.response);
                if(data.response.includes("```")) {
                    lastGeneratedCode = extractCode(data.response);
                }

            } catch(e) {
                document.getElementById(loadingId).innerText = "Hiba t√∂rt√©nt: " + e;
            }
        }

        // 3. F√ÅJL FELT√ñLT√âS (EZ AZ √öJ FUNKCI√ì!)
        async function uploadFile() {
            if(!token) return alert("Jelentkezz be!");
            
            const fileInput = document.getElementById("fileInput");
            const notes = document.getElementById("fileNotes").value || "Nincs jegyzet";
            
            if(fileInput.files.length === 0) return alert("V√°lassz ki egy f√°jlt!");

            const file = fileInput.files[0];
            const formData = new FormData();
            formData.append("file", file);
            formData.append("notes", notes);

            addMessage(`üìÇ F√°jl olvas√°sa √©s feldolgoz√°sa: <strong>${file.name}</strong>...`, "ai");

            try {
                const res = await fetch("/upload_knowledge", {
                    method: "POST",
                    headers: { "Authorization": "Bearer " + token }, // Fontos: Ne legyen Content-Type, a b√∂ng√©sz≈ë int√©zi!
                    body: formData
                });
                const data = await res.json();
                
                if(data.status === "success") {
                    addMessage(`‚úÖ <strong>SIKERES TANUL√ÅS!</strong><br>A f√°jlt elmentettem a mem√≥ri√°mba.<br><br><strong>Amit tanultam bel≈ële:</strong><br>${data.summary}`, "ai");
                } else {
                    addMessage("‚ùå Hiba a f√°jl feldolgoz√°sakor: " + data.message, "ai");
                }
            } catch(e) { addMessage("Kritikus hiba a felt√∂lt√©sn√©l.", "ai"); }
        }

        // 4. URL TANUL√ÅS (R√©gi)
        async function learnUrl() {
            if(!token) return alert("Jelentkezz be!");
            const url = document.getElementById("learnUrl").value;
            if(!url) return;
            
            addMessage("Weboldal szkennel√©se: " + url, "ai");

            try {
                const res = await fetch("/learn", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ url: url })
                });
                const data = await res.json();
                addMessage("‚úÖ Weboldal r√∂gz√≠tve. √ñsszefoglal√≥: " + data.summary, "ai");
            } catch(e) { addMessage("Hiba a weboldal olvas√°sakor.", "ai"); }
        }

        // 5. GITHUB DEPLOY
        async function deploy() {
            if(!token) return alert("Jelentkezz be!");
            if(!lastGeneratedCode) return alert("M√©g nincs gener√°lt k√≥d!");

            const repo = document.getElementById("repoName").value || "profit-agent-core";
            const file = document.getElementById("fileName").value || "main.py";

            addMessage(`üöÄ K√≥d felt√∂lt√©se a GitHubra (${repo}/${file})...`, "ai");

            try {
                const res = await fetch("/deploy-github", {
                    method: "POST",
                    headers: { "Content-Type": "application/json", "Authorization": "Bearer " + token },
                    body: JSON.stringify({ project_name: repo, file_name: file, code_content: lastGeneratedCode })
                });
                const data = await res.json();
                addMessage(`‚úÖ SIKER! A k√≥d √©les√≠tve: <a href="${data.url}" target="_blank" style="color:#fff; text-decoration:underline;">Megnyit√°s</a>`, "ai");
            } catch(e) { addMessage("Hiba a felt√∂lt√©sn√©l: " + e, "ai"); }
        }

        // --- SEG√âDF√úGGV√âNYEK ---
        function addMessage(text, sender) {
            const div = document.createElement("div");
            div.className = `message msg-${sender}`;
            div.id = "msg-" + Date.now();
            div.innerHTML = sender === 'ai' ? formatResponse(text) : text;
            document.getElementById("chatWindow").appendChild(div);
            document.getElementById("chatWindow").scrollTop = document.getElementById("chatWindow").scrollHeight;
            return div.id;
        }

        function formatResponse(text) {
            let formatted = text.replace(/\n/g, "<br>");
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, "<strong>$1</strong>"); // Bold sz√∂veg
            formatted = formatted.replace(/```([\s\S]*?)```/g, "<div class='code-block'>$1</div>"); // K√≥d blokk
            return formatted;
        }

        function extractCode(text) {
            const match = text.match(/```(?:python|html)?([\s\S]*?)```/);
            return match ? match[1].trim() : text;
        }
    </script>
</body>
</html>